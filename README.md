# AtroPIM Docker Setup

A fully containerized environment for AtroPIM, featuring a segregated architecture with dedicated containers for the Web Application, Background Cron Workers, Database, and Nginx.

## üèó Architecture

The setup uses a multi-stage build system to ensure environment consistency:

* **Base Image (`docker/base.Dockerfile`):** Built once, containing PHP 8.3, all required extensions, and system libraries.
* **App Container (`docker/app.Dockerfile`):** Runs `php-fpm`. Handles the core application logic and automatically installs AtroPIM via `composer` on the first run.
* **Cron Container (`docker/cron.Dockerfile`):** A dedicated container for background jobs. It uses a **Healthcheck** dependency to wait for the App container to finish installing before starting.
* **Web Container:** Nginx server, exposing port `8080` (dev) or `80` (prod).
* **DB Container:** PostgreSQL 16.

## üöÄ Getting Started

### Prerequisites
* Docker & Docker Compose
* Make (optional, but highly recommended)

### 1. Configuration
Copy the example environment files to create your local config:

```bash
# Create the dev environment file
cp .env.example .env.dev

# (Optional) Setup Staging/Prod if needed
cp .env.example .env.staging
cp .env.example .env.prod
```

Edit `.env.dev` to set your project name and database credentials:
```ini
PROJECT_NAME=my_pim
DB_NAME=atropim
DB_USER=atro
DB_PASS=secret
...
```

### 2. Start Development
Run the make command to spin up the environment:

```bash
make dev
```

**‚ö†Ô∏è Important Note on First Run:**
The first time you start the environment, the `app` container will detect that the `html/` directory is empty. It will automatically:
1.  Clone the AtroPIM skeleton.
2.  Run `composer update` to install dependencies.
3.  **This process takes roughly 60 seconds.**
4.  The `cron` container will stay in a "Created" state (waiting) until this process finishes. This is normal behavior.

Once the logs show the installation is complete, access the site at: `http://localhost:8080`.

## üõ† Command List

The included `Makefile` simplifies common Docker tasks.

| Command | Description |
| :--- | :--- |
| `make dev` | Start the development environment (detached mode). |
| `make dev-down` | Stop and remove containers. |
| `make dev-restart` | Restart all containers. |
| `make dev-logs` | Tail logs for all containers (App, Cron, DB, Web). Press `Ctrl+C` to exit. |
| `make dev-enter` | Open a Bash shell inside the `app` container (useful for running `composer` or `console` commands manually). |
| `make dev-build` | Force a rebuild of Docker images (run this if you change `Dockerfile`, `php.ini`, or `crontab`). |
| `make dev-clean` | **Danger:** Destroys the database volume and deletes the `html/` directory. Use this to reset everything for a fresh install. |

## üìÇ File Structure

* `docker/` - Contains the specific Dockerfiles for each service.
    * `base.Dockerfile` - Shared PHP environment.
    * `app.Dockerfile` - PHP-FPM configuration.
    * `cron.Dockerfile` - Cron daemon configuration.
* `config/` - Configuration files mounted into containers:
    * `nginx.conf` - Nginx server block configuration.
    * `php.custom.ini` - PHP overrides (memory limit, upload size, execution time).
    * `crontab` - The cron schedule definition.
* `html/` - The source code directory. This is auto-generated by the app container. **Do not commit core files here**, only your custom modules/themes.

## ‚öôÔ∏è Customization

### PHP Settings
To change PHP settings (e.g., increase memory limit or max upload size):
1. Edit `config/php.custom.ini`.
2. Restart the containers:
   ```bash
   make dev-restart
   ```

### Cron Schedule
To change the background job schedule:
1. Edit `config/crontab`.
2. **Rebuild the cron image** to apply the changes (the file is baked into the image):
   ```bash
   make dev-build
   ```
   *Note: The cron job is configured to pipe output to Docker logs (`/proc/1/fd/1`) so you can view activity via `make dev-logs`.*

### Environment Variables
Variables such as `DB_HOST`, `DB_PASS`, and `APP_ENV` are passed to containers via `.env.dev`.
The `cron` container is configured to automatically load these variables on startup, ensuring background jobs can connect to the database without manual intervention.

## ‚ùì Troubleshooting

### Cron container is not starting
If the `cron` container status remains as `Created` for a long time:
* **Cause:** It is waiting for the `app` container to become "healthy."
* **Solution:** Check the logs of the app container (`make dev-logs`). If the initial Composer installation failed, the healthcheck (which looks for `vendor/autoload.php`) will never pass. Fix the installation error in `app`, and `cron` will start automatically.

### Permission Denied when deleting html/
If you try to delete the `html/` folder manually and get "Permission Denied":
* **Cause:** Files created inside the container are owned by `www-data` or `root`, not your local user.
* **Solution:** Use the provided make command, which uses a temporary Docker container to perform the deletion cleanly:
    ```bash
    make dev-clean
    ```

### Port 8080 is already in use
* **Error:** `Bind for 0.0.0.0:8080 failed: port is already allocated`
* **Solution:** Open `docker-compose.dev.yml` and change the port mapping:
    ```yaml
    web:
      ports:
        - "8081:80"  # Change 8080 to 8081 (or any free port)
    ```

### Changes to crontab are not working
* **Cause:** The crontab file is copied into the Docker image at build time. Editing the local file does not update the running container immediately.
* **Solution:** You must rebuild the image to apply changes:
    ```bash
    make dev-build
    ```
